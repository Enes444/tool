services:
  api:
    build: ./backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - SPONSOR_OPS_ENV=${SPONSOR_OPS_ENV:-pilot}
      - SPONSOR_OPS_CORS_ORIGINS=${SPONSOR_OPS_CORS_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
      - SPONSOR_OPS_RATE_LIMIT_ENABLED=${SPONSOR_OPS_RATE_LIMIT_ENABLED:-1}
      - SPONSOR_OPS_RATE_LIMIT_REQUESTS_PER_MIN=${SPONSOR_OPS_RATE_LIMIT_REQUESTS_PER_MIN:-240}
      - SPONSOR_OPS_DB=/data/sponsor_ops.db
      - SPONSOR_OPS_JWT_SECRET=${SPONSOR_OPS_JWT_SECRET:?SPONSOR_OPS_JWT_SECRET is required (>=32 chars). Set it in .env or your environment}
      - SPONSOR_OPS_MAX_UPLOAD_MB=50
      - SPONSOR_OPS_UPLOAD_ROOT=uploads
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthz', timeout=3).read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    volumes:
      - sponsorops_data:/data
      - ./backend/uploads:/app/uploads

  web:
    build:
      context: ./frontend
      args:
        VITE_API_URL: ${VITE_API_URL:-http://127.0.0.1:8000}
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-5173}:80"
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://127.0.0.1:8000}
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://127.0.0.1/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    depends_on:
      api:
        condition: service_healthy

volumes:
  sponsorops_data: